<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="language" content="Spanish">
    <title>Página Dividida</title>
    <link rel="stylesheet" href="index.css">

    <!-- Agrega el SDK de JavaScript de Facebook -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/es_LA/sdk.js"></script>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

    <div class="container">
        <div class="panel izquierda" id="izquierda">
            <div class="imgzone">
                <div class="fixblock">
                    <div class="profile">
                        <img src="" alt="" class="pfp" id="profilePicture">
                        <h2 id="userName"></h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel derecha" id="derecha">
            <!-- Aquí se mostrará la imagen -->
        </div>
    </div>

    <!-- Botón de inicio de sesión de Facebook -->
    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button>
    <br>
    <button onclick="openTextAreaPanel()">Abrir Panel de Texto</button>
    <button onclick="captureImage()">Capturar Imagen</button>
    <a id="downloadLink" style="display: none;">Descargar Imagen</a>

    <!-- Panel con textarea adicional -->
    <div class="text-panel" id="textPanel" style="display: none;">
        <textarea id="additionalText" placeholder="Escribe aquí..." oninput="autoResizeAdditionalText(this)"></textarea>
        <button onclick="closeTextAreaPanel()">Cerrar Panel</button>
    </div>

    <script>
        // Inicializar el SDK de Facebook
        window.fbAsyncInit = function() {
            FB.init({
                appId      : '973427901041222',
                cookie     : true,
                xfbml      : true,
                version    : 'v12.0'
            });

            FB.AppEvents.logPageView();

            // Llamar a otras funciones después de la inicialización si es necesario
        };

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // Resto del código...
        // Funciones para manejar el panel de texto adicional
        function openTextAreaPanel() {
            document.getElementById('textPanel').style.display = 'block';
        }

        function closeTextAreaPanel() {
            var additionalTextContent = document.getElementById('additionalText').value;
            document.getElementById('textPanel').style.display = 'none';

            // Obtener el div de fixblock
            var fixblockDiv = document.querySelector('.fixblock');

            // Eliminar cualquier contenido existente dentro de fixblock
            while (fixblockDiv.firstChild) {
                fixblockDiv.removeChild(fixblockDiv.firstChild);
            }

            // Crear un nuevo párrafo y agregarlo a fixblock
            var pElement = document.createElement('p');
            pElement.innerHTML = additionalTextContent.replace(/\n/g, '<br>');
            fixblockDiv.appendChild(pElement);

            // Actualizar la imagen
            actualizarImagen();
        }

        function autoResizeAdditionalText(element) {
            element.style.height = "auto";
            element.style.height = (element.scrollHeight) + "px";
        }

        function autoResize(element) {
            element.style.height = "auto";
            element.style.height = (element.scrollHeight) + "px";
            actualizarImagen();
        }

        function actualizarImagen() {
            var divElement = document.getElementById("izquierda");

            html2canvas(divElement, { scale: 2 }).then(function(canvas) {
                var imgData = canvas.toDataURL("image/png");

                var derechaPanel = document.getElementById("derecha");

                while (derechaPanel.firstChild) {
                    derechaPanel.removeChild(derechaPanel.firstChild);
                }

                var imgTag = document.createElement("img");
                imgTag.src = imgData;

                derechaPanel.appendChild(imgTag);
            });
        }

        // Función para manejar el estado de inicio de sesión
        function checkLoginState() {
            FB.getLoginStatus(function(response) {
                if (response.status === 'connected') {
                    // El usuario está conectado, obtenemos la información del perfil
                    getUserInfo();
                } else {
                    console.error('El usuario no está conectado a Facebook.');
                }
            });
        }

        // Función para obtener la información del perfil del usuario
        function getUserInfo() {
            FB.api('/me', {fields: 'id,name,picture'}, function(response) {
                console.log(response); // Agrega esta línea para imprimir la respuesta en la consola

                if (response.picture && response.picture.data && response.picture.data.url) {
                    var profilePicture = document.getElementById('profilePicture');
                    profilePicture.onload = function() {
                        console.log('Imagen cargada:', profilePicture.width, 'x', profilePicture.height);
                        // Resto del código...
                    };
                    profilePicture.src = response.picture.data.url;
                } else {
                    console.error('Error al obtener la URL de la imagen de perfil.');
                }
            });
        }

        window.addEventListener("load", function() {
            actualizarImagen();
        });
    </script>
    
</body>
</html>
